#include <avr/pgmspace.h>
#include "Device.hpp"

const uint8_t testApp[] PROGMEM = {
    'T', 1, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
    'T', 2, 0xFF, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0xFF,
    
    'B', 0, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 1, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 2, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 3, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 4, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 5, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 6, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 7, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 8, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 9, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 10, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 11, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 12, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 13, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 14, 2, 0, 0, 0, 0, 0, 0, 0,
    'B', 15, 2, 0, 0, 0, 0, 0, 0, 0,
    'U', 'M', 0, 0, 0, 0, 0, 0, 0, 0,
    
    'S', 0, 'W', 5, 5, 1, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
    'S', 0, 'X', 'R', 2, 0, 0, 0, 0, 0,
    'U', 'S', 0, 0, 0, 0, 0, 0, 0, 0,
};
gamecard::VirtualMachine vm;

void setup() {
    Serial.begin(9600);
    vm.init();
}

void loop() {
    uint8_t cmd[8];
    for(int j = 0; j < VM_CMD_LEN; j++) {
        cmd[j] = pgm_read_byte_near(testApp + vm.pc * VM_CMD_LEN + j);
    }
    
    vm.execute(cmd);
    
    while(vm.pc >= sizeof(testApp) / VM_CMD_LEN);
}

